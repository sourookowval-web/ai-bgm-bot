"""
YouTubeè‡ªå‹•æŠ•ç¨¿ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

æ©Ÿèƒ½:
    - YouTube Data API v3 ã‚’ä½¿ç”¨
    - OAuth 2.0 refresh token ã§èªè¨¼
    - å‹•ç”»ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¨ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿è¨­å®š
"""

import os
import sys
from pathlib import Path
from datetime import datetime
from google.oauth2.credentials import Credentials
from googleapiclient.discovery import build
from googleapiclient.http import MediaFileUpload

OUTPUT_DIR = Path("output")

def get_youtube_client():
    """YouTube API ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’å–å¾—"""
    
    # ç’°å¢ƒå¤‰æ•°ã‹ã‚‰èªè¨¼æƒ…å ±ã‚’å–å¾—
    client_id = os.getenv('YOUTUBE_CLIENT_ID')
    client_secret = os.getenv('YOUTUBE_CLIENT_SECRET')
    refresh_token = os.getenv('YOUTUBE_REFRESH_TOKEN')
    
    if not all([client_id, client_secret, refresh_token]):
        print("âŒ YouTube API ã®èªè¨¼æƒ…å ±ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“")
        print("GitHub Secrets ã«ä»¥ä¸‹ã‚’è¨­å®šã—ã¦ãã ã•ã„:")
        print("  - YOUTUBE_CLIENT_ID")
        print("  - YOUTUBE_CLIENT_SECRET")
        print("  - YOUTUBE_REFRESH_TOKEN")
        sys.exit(1)
    
    # èªè¨¼æƒ…å ±ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
    credentials = Credentials(
        None,
        refresh_token=refresh_token,
        token_uri="https://oauth2.googleapis.com/token",
        client_id=client_id,
        client_secret=client_secret
    )
    
    # YouTube API ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä½œæˆ
    youtube = build('youtube', 'v3', credentials=credentials)
    
    return youtube

def read_metadata():
    """ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æƒ…å ±ã‚’å–å¾—"""
    today = datetime.now().strftime('%Y-%m-%d')
    metadata_file = OUTPUT_DIR / f"{today}_metadata.txt"
    
    metadata = {}
    if metadata_file.exists():
        with open(metadata_file, 'r', encoding='utf-8') as f:
            for line in f:
                if ':' in line:
                    key, value = line.split(':', 1)
                    metadata[key.strip()] = value.strip()
    
    return metadata

def create_video_metadata(prompt):
    """å‹•ç”»ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ"""
    
    # ã‚¿ã‚¤ãƒˆãƒ«ç”Ÿæˆ
    today = datetime.now().strftime('%Y/%m/%d')
    title = f"ğŸµ {prompt.title()} | 60 Min Chill BGM for Study/Work/Relax [{today}]"
    
    # èª¬æ˜æ–‡ç”Ÿæˆ
    description = f"""
ğŸµ {prompt.title()} - 60 Minutes Chill Background Music

Perfect for studying, working, relaxing, or just chilling out.
This music was generated using AI (ACE-Step 1.5) and is copyright-free.

ğŸ§ Tracklist:
00:00 - {prompt.title()}

ğŸ“ Tags:
#lofi #chillmusic #studymusic #bgm #relaxing #ambient #peaceful

ğŸ¤– Generated by AI BGM BOT
Music: ACE-Step 1.5
Background: Stable Diffusion

ğŸ“… Upload Date: {today}

---

âš ï¸ Copyright Notice:
This music is AI-generated and free to use.
Feel free to enjoy it for personal use.

ğŸ’– Thank you for listening!
Please subscribe for more chill music ğŸ””
""".strip()
    
    # ã‚¿ã‚°
    tags = [
        'lofi', 'chill', 'bgm', 'study music', 'work music',
        'relaxing', 'ambient', 'peaceful', 'ai music', 'copyright free'
    ]
    
    return {
        'title': title,
        'description': description,
        'tags': tags,
        'category_id': '10',  # Music category
        'privacy_status': 'public'  # public, unlisted, or private
    }

def upload_video(youtube, video_path, thumbnail_path, metadata):
    """
    YouTubeã«å‹•ç”»ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    
    Args:
        youtube: YouTube API ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
        video_path: å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹
        thumbnail_path: ã‚µãƒ ãƒã‚¤ãƒ«ãƒ‘ã‚¹
        metadata: å‹•ç”»ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
    """
    print(f"ğŸ“¤ YouTube ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹")
    print(f"ğŸ“¹ å‹•ç”»: {video_path}")
    print(f"ğŸ–¼ï¸  ã‚µãƒ ãƒã‚¤ãƒ«: {thumbnail_path}")
    print(f"ğŸ“ ã‚¿ã‚¤ãƒˆãƒ«: {metadata['title']}")
    
    try:
        # å‹•ç”»ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
        body = {
            'snippet': {
                'title': metadata['title'],
                'description': metadata['description'],
                'tags': metadata['tags'],
                'categoryId': metadata['category_id']
            },
            'status': {
                'privacyStatus': metadata['privacy_status'],
                'selfDeclaredMadeForKids': False
            }
        }
        
        # å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        media = MediaFileUpload(
            video_path,
            chunksize=1024*1024,  # 1MB chunks
            resumable=True
        )
        
        print("ğŸš€ å‹•ç”»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...")
        request = youtube.videos().insert(
            part='snippet,status',
            body=body,
            media_body=media
        )
        
        response = None
        while response is None:
            status, response = request.next_chunk()
            if status:
                progress = int(status.progress() * 100)
                print(f"ğŸ“Š ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é€²æ—: {progress}%")
        
        video_id = response['id']
        print(f"âœ… å‹•ç”»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼")
        print(f"ğŸ¬ å‹•ç”»ID: {video_id}")
        print(f"ğŸ”— URL: https://www.youtube.com/watch?v={video_id}")
        
        # ã‚µãƒ ãƒã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if thumbnail_path.exists():
            print("ğŸ–¼ï¸  ã‚µãƒ ãƒã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...")
            youtube.thumbnails().set(
                videoId=video_id,
                media_body=MediaFileUpload(thumbnail_path)
            ).execute()
            print("âœ… ã‚µãƒ ãƒã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼")
        
        return video_id
        
    except Exception as e:
        print(f"âŒ YouTubeã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: {e}")
        return None

def main():
    """ãƒ¡ã‚¤ãƒ³å‡¦ç†"""
    print("=" * 60)
    print("ğŸ“¤ YouTube è‡ªå‹•æŠ•ç¨¿")
    print("=" * 60)
    
    # ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹
    today = datetime.now().strftime('%Y-%m-%d')
    video_path = OUTPUT_DIR / f"{today}_video.mp4"
    thumbnail_path = OUTPUT_DIR / f"{today}_thumbnail.jpg"
    
    # ãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨ç¢ºèª
    if not video_path.exists():
        print(f"âŒ å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: {video_path}")
        sys.exit(1)
    
    # ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾—
    metadata_dict = read_metadata()
    prompt = metadata_dict.get('prompt', 'Chill BGM')
    
    # YouTube ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ä½œæˆ
    video_metadata = create_video_metadata(prompt)
    
    # YouTube ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå–å¾—
    youtube = get_youtube_client()
    
    # å‹•ç”»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    video_id = upload_video(youtube, video_path, thumbnail_path, video_metadata)
    
    if video_id:
        print("")
        print("âœ… YouTubeæŠ•ç¨¿å®Œäº†ï¼")
        print(f"ğŸ¬ å‹•ç”»ID: {video_id}")
        print(f"ğŸ”— URL: https://www.youtube.com/watch?v={video_id}")
        print("")
    else:
        print("âŒ YouTubeæŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ")
        sys.exit(1)

if __name__ == '__main__':
    main()
