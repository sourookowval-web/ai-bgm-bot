name: ğŸµ Auto BGM Generator & YouTube Uploader

on:
  schedule:
    # æ¯é€±æœˆãƒ»æ°´ãƒ»é‡‘ã® 9:00 UTC (æ—¥æœ¬æ™‚é–“ 18:00)
    - cron: '0 9 * * 1,3,5'
  
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  generate-and-upload:
    runs-on: ubuntu-latest
    
    steps:
      # ===== 1. ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ =====
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      # ===== 2. Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— =====
      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      # ===== 3. uvã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« =====
      - name: ğŸ“¦ Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH
      
      # ===== 4. ACE-Stepã‚¯ãƒ­ãƒ¼ãƒ³ & ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« =====
      - name: ğŸµ Clone and install ACE-Step
        run: |
          git clone https://github.com/ACE-Step/ACE-Step-1.5.git
          cd ACE-Step-1.5
          uv sync
          # ç’°å¢ƒã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ãƒˆï¼ˆuvã®ä»®æƒ³ç’°å¢ƒã‚’ä½¿ç”¨ï¼‰
          echo "ACESTEP_DIR=$(pwd)" >> $GITHUB_ENV
        timeout-minutes: 15
      
      # ===== 5. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« =====
      - name: ğŸ“¦ Install project dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      # ===== 6. ACE-StepéŸ³æ¥½ç”Ÿæˆ =====
      - name: ğŸµ Generate music with ACE-Step
        run: |
          # ACE-Stepã®ä»®æƒ³ç’°å¢ƒã‚’ä½¿ç”¨
          cd ACE-Step-1.5
          uv run python ../scripts/generate_music.py
        timeout-minutes: 30
      
      # ===== 7. Stable DiffusionèƒŒæ™¯ç”Ÿæˆ =====
      - name: ğŸ–¼ï¸ Generate background image
        run: |
          python scripts/generate_background.py
        timeout-minutes: 10
      
      # ===== 8. ffmpegã§å‹•ç”»åŒ– =====
      - name: ğŸ¬ Create video with ffmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          python scripts/create_video.py
        timeout-minutes: 15
      
      # ===== 9. YouTubeæŠ•ç¨¿ =====
      - name: ğŸ“¤ Upload to YouTube
        env:
          YOUTUBE_CLIENT_ID: ${{ secrets.YOUTUBE_CLIENT_ID }}
          YOUTUBE_CLIENT_SECRET: ${{ secrets.YOUTUBE_CLIENT_SECRET }}
          YOUTUBE_REFRESH_TOKEN: ${{ secrets.YOUTUBE_REFRESH_TOKEN }}
        run: |
          python scripts/upload_youtube.py
        timeout-minutes: 20
      
      # ===== 10. ç”Ÿæˆç‰©ã‚’ä¿å­˜ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰ =====
      - name: ğŸ’¾ Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bgm-video-${{ github.run_number }}
          path: |
            output/*.wav
            output/*.mp4
            output/*.jpg
            output/*.txt
          retention-days: 7
      
      # ===== 11. é€šçŸ¥ =====
      - name: ğŸ“¢ Notify completion
        if: success()
        run: |
          echo "âœ… BGMå‹•ç”»ã®ç”Ÿæˆãƒ»æŠ•ç¨¿ãŒå®Œäº†ã—ã¾ã—ãŸï¼"
          echo "ğŸ“º YouTubeã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„"
