name: ğŸµ Auto BGM Generator & YouTube Uploader

on:
  schedule:
    # æ¯é€±æœˆãƒ»æ°´ãƒ»é‡‘ã® 9:00 UTC (æ—¥æœ¬æ™‚é–“ 18:00)
    - cron: '0 9 * * 1,3,5'
  
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  generate-and-upload:
    runs-on: ubuntu-latest
    
    steps:
      # ===== 1. ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ =====
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      # ===== 2. Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— =====
      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      # ===== 3. ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« =====
      - name: ğŸ“¦ Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      # ===== 4. ACE-StepéŸ³æ¥½ç”Ÿæˆ =====
      - name: ğŸµ Generate music with ACE-Step
        run: |
          python scripts/generate_music.py
        timeout-minutes: 30
      
      # ===== 5. Stable DiffusionèƒŒæ™¯ç”Ÿæˆ =====
      - name: ğŸ–¼ï¸ Generate background image
        run: |
          python scripts/generate_background.py
        timeout-minutes: 10
      
      # ===== 6. ffmpegã§å‹•ç”»åŒ– =====
      - name: ğŸ¬ Create video with ffmpeg
        run: |
          python scripts/create_video.py
        timeout-minutes: 15
      
      # ===== 7. YouTubeæŠ•ç¨¿ =====
      - name: ğŸ“¤ Upload to YouTube
        env:
          YOUTUBE_CLIENT_ID: ${{ secrets.YOUTUBE_CLIENT_ID }}
          YOUTUBE_CLIENT_SECRET: ${{ secrets.YOUTUBE_CLIENT_SECRET }}
          YOUTUBE_REFRESH_TOKEN: ${{ secrets.YOUTUBE_REFRESH_TOKEN }}
        run: |
          python scripts/upload_youtube.py
        timeout-minutes: 20
      
      # ===== 8. ç”Ÿæˆç‰©ã‚’ä¿å­˜ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰ =====
      - name: ğŸ’¾ Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bgm-video-${{ github.run_number }}
          path: |
            output/*.wav
            output/*.mp4
            output/*.jpg
            output/*.txt
          retention-days: 7
      
      # ===== 9. é€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰ =====
      - name: ğŸ“¢ Notify completion
        if: success()
        run: |
          echo "âœ… BGMå‹•ç”»ã®ç”Ÿæˆãƒ»æŠ•ç¨¿ãŒå®Œäº†ã—ã¾ã—ãŸï¼"
          echo "ğŸ“º YouTubeã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„"
